<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		MySQL | 
	 
	月伴飞鱼
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/%E5%A4%B4%E5%83%8F.jpg">
	
  
  	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="/css/jquery.fancybox.min.css">

	
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="/lib/highlight/darcula.css">

	
<link rel="stylesheet" href="/css/clipboard-use.css">


	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">

	
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>


	
<script src="/lib/highlight/highlight.min.js"></script>

	
<script src="https://readmore.openwrite.cn/js/readmore.js"></script>

	
<script src="/lib/jquery-3.4.1.min.js"></script>

	
<script src="/lib/jquery.pjax.js"></script>


	
<script src="/js/main.js"></script>

	
<script src="/js/jquery.fancybox.min.js"></script>

	
		
<script src="/lib/valine/av-3.0.4-min.js"></script>

		
<script src="/lib/valine/Valine-1.3.10-min.js"></script>

	
	
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
	
<script src="/js/clipboard.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body oncontextmenu="return false;">
	<header id="header">
    <a id="title" href="/" class="logo">公众号月伴飞鱼</a>

	<ul id="menu">
		<li class="menu-item">
			<a href="/about" class="menu-item-link">关于我</a>
		</li>

	    <li class="menu-item">
			<a href="/site" class="menu-item-link">关于网站</a>
		</li>

		<li class="menu-item">
			<a href="/个人公众号.jpg" class="menu-item-link" target="_blank">我的公众号</a>
		</li>
		
		<li class="menu-item">
			<a href="https://tech.meituan.com/" class="menu-item-link" target="_blank">
				美团技术团队
			</a>
		</li>
		<li class="menu-item">
			<a href="https://tech.youzan.com/" class="menu-item-link" target="_blank">
				有赞技术团队
			</a>
		</li>
		<!--<li class="menu-item">
			<select class="menu-item-link menu-item-select">
				<option class="menu-item-link"  value="volvo">Volvo</option>
				<option class="menu-item-link"  value="saab">Saab</option>
				<option class="menu-item-link"  value="fiat">Fiat</option>
				<option class="menu-item-link"  value="audi">Audi</option>
			</select>
		</li>-->
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="text" placeholder="按目录搜索一下">
		<div id="tree">
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										中间件
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/30/%E4%B8%AD%E9%97%B4%E4%BB%B6/Dubbo/">
										Dubbo
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/12/19/%E4%B8%AD%E9%97%B4%E4%BB%B6/Elasticsearch/">
										Elasticsearch
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/30/%E4%B8%AD%E9%97%B4%E4%BB%B6/Netty/">
										Netty
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/19/%E4%B8%AD%E9%97%B4%E4%BB%B6/ZooKeeper/">
										ZooKeeper
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										代码思想
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/11/02/%E4%BB%A3%E7%A0%81%E6%80%9D%E6%83%B3/%E4%BB%A3%E7%A0%81%E9%87%8D%E6%9E%84/">
										代码重构
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										前端相关
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/07/%E5%89%8D%E7%AB%AF%E7%9B%B8%E5%85%B3/CSS/">
										CSS
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/07/%E5%89%8D%E7%AB%AF%E7%9B%B8%E5%85%B3/Vue/">
										Vue
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/12/%E5%89%8D%E7%AB%AF%E7%9B%B8%E5%85%B3/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">
										小程序
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										基础知识
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/11/11/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/Go%E5%9F%BA%E7%A1%80/">
										Go基础
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/11/27/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/JVM/">
										JVM
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/11/21/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/Java%E5%9F%BA%E7%A1%80/">
										Java基础
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/07/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%88%86%E5%B8%83%E5%BC%8F/">
										分布式
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/12/10/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">
										并发编程
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/07/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
										设计模式
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										娱乐相关
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/27/%E5%A8%B1%E4%B9%90%E7%9B%B8%E5%85%B3/%E4%B9%A6%E7%B1%8D/">
										书籍
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/10/%E5%A8%B1%E4%B9%90%E7%9B%B8%E5%85%B3/%E7%94%B5%E5%BD%B1/">
										电影
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/05/%E5%A8%B1%E4%B9%90%E7%9B%B8%E5%85%B3/%E7%9F%A5%E8%AF%86/">
										知识
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/09/%E5%A8%B1%E4%B9%90%E7%9B%B8%E5%85%B3/%E9%9F%B3%E4%B9%90/">
										音乐
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										学习专栏
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/31/%E5%AD%A6%E4%B9%A0%E4%B8%93%E6%A0%8F/%E4%BB%A3%E7%A0%81%E4%B9%8B%E4%B8%91/">
										代码之丑
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/26/%E5%AD%A6%E4%B9%A0%E4%B8%93%E6%A0%8F/%E5%A4%A7%E5%8E%82%E6%99%8B%E5%8D%87%E6%8C%87%E5%8D%97/">
										大厂晋升指南
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										学习书籍
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/11/16/%E5%AD%A6%E4%B9%A0%E4%B9%A6%E7%B1%8D/Java%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/">
										Java开发手册
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										工具相关
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/11/09/%E5%B7%A5%E5%85%B7%E7%9B%B8%E5%85%B3/Arthas/">
										Arthas
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/21/%E5%B7%A5%E5%85%B7%E7%9B%B8%E5%85%B3/GIT/">
										GIT
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/21/%E5%B7%A5%E5%85%B7%E7%9B%B8%E5%85%B3/Hexo/">
										Hexo
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/21/%E5%B7%A5%E5%85%B7%E7%9B%B8%E5%85%B3/MAC/">
										MAC
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/01/%E5%B7%A5%E5%85%B7%E7%9B%B8%E5%85%B3/Maven/">
										Maven
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/07/%E5%B7%A5%E5%85%B7%E7%9B%B8%E5%85%B3/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">
										实用工具
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										成长相关
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/31/%E6%88%90%E9%95%BF%E7%9B%B8%E5%85%B3/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/">
										技术学习
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/09/%E6%88%90%E9%95%BF%E7%9B%B8%E5%85%B3/%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3/">
										面试相关
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										数据库
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/27/%E6%95%B0%E6%8D%AE%E5%BA%93/HBase/">
										HBase
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/09/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/">
										MongoDB
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/2022/12/02/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">
										MySQL
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/21/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/">
										Redis
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										服务器
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/07/%E6%9C%8D%E5%8A%A1%E5%99%A8/Docker/">
										Docker
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/09/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/">
										Nginx
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/03/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/">
										Tomcat
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/09/%E6%9C%8D%E5%8A%A1%E5%99%A8/%E8%BF%90%E7%BB%B4%E7%9F%A5%E8%AF%86/">
										运维知识
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										架构相关
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/21/%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3/DDD/">
										DDD
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/02/%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3/%E6%9E%B6%E6%9E%84%E5%9B%BE/">
										架构图
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/02/%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3/%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0/">
										架构学习
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/26/%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3/%E7%B3%BB%E7%BB%9F%E4%BF%9D%E9%9A%9C/">
										系统保障
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/31/%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3/%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD/">
										系统性能
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/26/%E6%9E%B6%E6%9E%84%E7%9B%B8%E5%85%B3/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">
										系统设计
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										框架相关
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/11/15/%E6%A1%86%E6%9E%B6%E7%9B%B8%E5%85%B3/JWT/">
										JWT
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/08/%E6%A1%86%E6%9E%B6%E7%9B%B8%E5%85%B3/MyBatis/">
										MyBatis
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/14/%E6%A1%86%E6%9E%B6%E7%9B%B8%E5%85%B3/RPC%E6%A1%86%E6%9E%B6/">
										RPC框架
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/26/%E6%A1%86%E6%9E%B6%E7%9B%B8%E5%85%B3/Seata/">
										Seata
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/14/%E6%A1%86%E6%9E%B6%E7%9B%B8%E5%85%B3/Spring/">
										Spring
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/03/%E6%A1%86%E6%9E%B6%E7%9B%B8%E5%85%B3/Thrift/">
										Thrift
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/10/%E6%A1%86%E6%9E%B6%E7%9B%B8%E5%85%B3/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/">
										开源框架
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										消息队列
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/07/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/KAFKA/">
										KAFKA
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/07/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/RocketMQ/">
										RocketMQ
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										算法相关
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/11/26/%E7%AE%97%E6%B3%95%E7%9B%B8%E5%85%B3/LeetCode/">
										LeetCode
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/11/26/%E7%AE%97%E6%B3%95%E7%9B%B8%E5%85%B3/%E5%89%91%E6%8C%87OFFER/">
										剑指OFFER
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/11/25/%E7%AE%97%E6%B3%95%E7%9B%B8%E5%85%B3/%E9%9D%A2%E8%AF%95%E7%AE%97%E6%B3%95/">
										面试算法
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										系统相关
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/11/19/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E4%BB%BB%E5%8A%A1%E7%B3%BB%E7%BB%9F/">
										任务系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/18/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E5%B9%BF%E5%91%8A%E7%B3%BB%E7%BB%9F/">
										广告系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/19/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E6%89%93%E8%BD%A6%E7%B3%BB%E7%BB%9F/">
										打车系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/18/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/">
										推荐系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/19/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E7%94%A8%E6%88%B7%E7%B3%BB%E7%BB%9F/">
										用户系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/19/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E7%9B%B4%E6%92%AD%E7%B3%BB%E7%BB%9F/">
										直播系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/19/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F/">
										短链系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/19/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E7%A4%BE%E5%8C%BA%E7%B3%BB%E7%BB%9F/">
										社区系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/19/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/">
										秒杀系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/19/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E7%BA%A2%E5%8C%85%E7%B3%BB%E7%BB%9F/">
										红包系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/18/%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/%E8%AE%A2%E5%8D%95%E7%B3%BB%E7%BB%9F/">
										订单系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										英语相关
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										老友记
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/08/%E8%8B%B1%E8%AF%AD%E7%9B%B8%E5%85%B3/%E8%80%81%E5%8F%8B%E8%AE%B0/%E7%AC%AC%E4%B8%80%E5%AD%A3/">
										第一季
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/08/%E8%8B%B1%E8%AF%AD%E7%9B%B8%E5%85%B3/%E8%80%81%E5%8F%8B%E8%AE%B0/%E7%AC%AC%E4%B8%89%E5%AD%A3/">
										第三季
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/11/23/%E8%8B%B1%E8%AF%AD%E7%9B%B8%E5%85%B3/%E8%80%81%E5%8F%8B%E8%AE%B0/%E7%AC%AC%E4%BA%94%E5%AD%A3/">
										第五季
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										雅思
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/12/%E8%8B%B1%E8%AF%AD%E7%9B%B8%E5%85%B3/%E9%9B%85%E6%80%9D/%E5%89%91%E6%A1%A5%E9%9B%85%E6%80%9D%E5%90%AC%E5%8A%9B%E7%9C%9F%E9%A2%98/">
										剑桥雅思听力真题
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										计算机基础
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/10/10/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
										操作系统
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/10/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">
										数据结构
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/10/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E7%AE%97%E6%B3%95%E7%9F%A5%E8%AF%86/">
										算法知识
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/12/19/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/">
										网络基础
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">

	MySQL
</h1>
<div class="article-meta">
	<span>月伴飞鱼</span>
	<span>2022-12-02 22:50:23</span>
    
		<div id="article-categories">
            
                
                    <span>
                        <i class="fa fa-folder" aria-hidden="true"></i>
                        <a href="/categories/数据库/">数据库</a>
						
                    </span>
                
            
		</div>
    
</div>

<div id="container" class = "content999" oncontextmenu="return false;">
	<div id="article-content">
		<p><strong>三大范式</strong></p>
<p>第一范式：</p>
<blockquote>
<p>确保每列保持原子性：也就是列都是不可再分。</p>
<p>如果每列都是不可再分的最小数据单元（也称为最小的原子单元），则满足第一范式（1NF）</p>
</blockquote>
<p>第二范式：</p>
<blockquote>
<p>首先满足第一范式，并且表中非主键列<strong>不存在</strong>对主键的部分依赖。</p>
<ul>
<li>第二范式要求每个表只描述一件事情。</li>
</ul>
</blockquote>
<p>第三范式:</p>
<blockquote>
<p>确保每列都和主键列直接相关,而不是间接相关。</p>
<ul>
<li>满足第二范式，并且表中的列<strong>不存在</strong>对非主键列的传递依赖。</li>
</ul>
</blockquote>
<p><strong>MyISAM与InnoDB的区别</strong></p>
<blockquote>
<p>InnoDB支持事务，MyISAM不支持。</p>
<p>InnoDB支持外键，MyISAM不支持。</p>
<p>InnoDB是聚集索引，数据文件是和索引绑在一起的。</p>
<p>MyISAM是非聚集索引，索引和数据文件是分离的，索引保存的是数据文件的指针。</p>
<p>InnoDB不保存表的具体行数，执行<code>select count(*) from table</code>时需要全表扫描。</p>
<p>MyISAM用一个变量保存了整个表的行数，执行上述语句时只需要读出该变量即可，速度很快。</p>
<p>InnoDB支持表、行(默认)级锁，MyISAM支持表级锁。</p>
</blockquote>
<p><strong>Join语句</strong></p>
<p><code>left join、right join、inner join</code>的区别：</p>
<blockquote>
<p>left join(左连接)：</p>
<ul>
<li>返回包括左表中的所有记录和右表中联结字段相等的记录。</li>
<li>左表是驱动表，右表是被驱动表。</li>
</ul>
<p>right join(右连接)：</p>
<ul>
<li>返回包括右表中的所有记录和左表中联结字段相等的记录。</li>
<li>右表是驱动表，左表是被驱动表。</li>
</ul>
<p>inner join(等值连接)：</p>
<ul>
<li>只返回两个表中联结字段相等的行。</li>
<li>数据量比较小的表作为驱动表，大表作为被驱动表。</li>
</ul>
</blockquote>
<hr>
<blockquote>
<p>join查询在有索引条件下：</p>
<ul>
<li>驱动表有索引不会使用到索引。</li>
<li>被驱动表建立索引会使用到索引。</li>
</ul>
<p>所以在以小表驱动大表的情况下，给大表建立索引会大大提高执行速度。</p>
</blockquote>
<p>Join原理：</p>
<blockquote>
<p>Simple Nested-Loop:</p>
<ul>
<li><p>驱动表中的每一条记录与被驱动表中的记录进行比较判断（就是个笛卡尔积）。</p>
</li>
<li><p>对于两表联接来说，驱动表只会被访问一遍，但被驱动表却要被访问到好多遍。</p>
</li>
</ul>
<p>Index Nested-Loop：</p>
<ul>
<li>基于索引进行连接的算法。</li>
<li>它要求被驱动表上有索引，可以通过索引来加速查询。</li>
</ul>
<p>Block Nested-Loop：</p>
<ul>
<li>它使用Join Buffer来减少内部循环读取表的次数。</li>
<li>Join Buffer用以缓存联接需要的列。</li>
</ul>
<p>选择Join算法优先级：</p>
<ul>
<li>Index Nested-LoopJoin &gt; Block Nested-Loop Join &gt; Simple Nested-Loop Join。</li>
</ul>
<p>当不使用<code>Index Nested-Loop Join</code>的时候，默认使用<code>Block Nested-Loop Join</code>。</p>
</blockquote>
<img src="/images/image-20231025215619612.png" alt="image-20231025215619612" style="zoom:50%;" />

<p><strong>分页查询优化</strong></p>
<pre><code class="sql">select * from table where type = 2 and level = 9 order by id asc limit 190289,10;
</code></pre>
<blockquote>
<p>延迟关联：</p>
<ul>
<li>先通过where条件提取出主键，在将该表与原数据表关联，通过主键id提取数据行，而不是通过原来的二级索引提取数据行</li>
</ul>
</blockquote>
<pre><code class="sql">select a.* from table a, (select id from table where type = 2 and level = 9 order by id asc limit 190289,10 ) b where a.id = b.id
</code></pre>
<blockquote>
<p>书签方式:</p>
<ul>
<li>找到limit第一个参数对应的主键值，再根据这个主键值再去过滤并limit</li>
</ul>
</blockquote>
<pre><code class="sql">select * from table where id &gt; (select * from table where type = 2 and level = 9 order by id asc limit 190289, 1) limit 10;
</code></pre>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p><strong>ACID</strong></p>
<blockquote>
<p>原子性（atomicity）:</p>
<ul>
<li>指事务是一个不可分割的工作单位，要么全部提交，要么全部失败回滚。</li>
</ul>
<p>一致性（consistency）：</p>
<ul>
<li>指事务执行前后，数据从一个合法性状态变换到另外一个合法性状态。<ul>
<li>这种状态是语义上的而不是语法上的，跟具体的业务有关。</li>
</ul>
</li>
</ul>
<p>隔离型（isolation）：</p>
<ul>
<li>指一个事务的执行不能被其他事务干扰。</li>
<li>即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。</li>
</ul>
<p>持久性（durability）：</p>
<ul>
<li>指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，其他操作和数据库故障不应该对其有任何影响。</li>
</ul>
</blockquote>
<p><strong>数据并发产生的问题</strong></p>
<blockquote>
<p>丢失更新（Lost Update）</p>
<ul>
<li>两个事务 Session A、Session B，如果事务Session A 修改了另一个未提交事务Session B 修改过的数据，意味着发生了丢失更新。</li>
</ul>
<p>脏读（ Dirty Read ）：</p>
<ul>
<li>两个事务 Session A、Session B，Session A 读取了已经被 Session B 更新但还没有被提交的字段。<ul>
<li>之后如果 Session B 回滚，那么Session A 读取的内容就是临时且无效的。</li>
</ul>
</li>
</ul>
<p>不可重复读（ Non-Repeatable Read ）：</p>
<ul>
<li>两个事务Session A、Session B，Session A 读取了一个字段，然后 Session B 更新了该字段。<ul>
<li>之后 Session A 再次读取同一个字段，该字段的值发生了变化。</li>
</ul>
</li>
</ul>
<p>幻读（ Phantom ）：</p>
<ul>
<li>两个事务Session A、Session B, Session A 从一个表中读取了一个字段, 然后 Session B 在该表中插入了一些新的行。 <ul>
<li>如果 Session A 再次读取同一个表, 就会多出几行。</li>
</ul>
</li>
</ul>
</blockquote>
<p><strong>事务隔离级别</strong></p>
<blockquote>
<p>READ UNCOMMITTED（读未提交）：</p>
<ul>
<li>所有事务都可以看到其他未提交事务的执行结果，不能避免脏读、不可重复读、幻读。</li>
</ul>
<p>READ COMMITTED（读已提交）：</p>
<ul>
<li>一个事务只能看见已经提交事务所做的改变。</li>
<li>可以避免脏读，但不可重复读、幻读问题仍然存在。</li>
</ul>
<p>REPEATABLE READ（重复读）：</p>
<ul>
<li>事务A在读到一条数据之后，此时事务B对该数据进行了修改并提交，事务A再读该数据，读到的还是原来的内容。</li>
<li>可以避免脏读、不可重复读，但幻读问题仍然存在，这是MySQL的默认隔离级别。</li>
</ul>
<p>SERIALIZABLE（可串行化）：</p>
<ul>
<li>确保事务可以从一个表中读取相同的行。</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>丢失更新</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>Read uncommitted</td>
<td>×</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Read committed</td>
<td>×</td>
<td>×</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Repeatable read（默认）</td>
<td>×</td>
<td>×</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>Serializable</td>
<td>×</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
</tbody></table>
<p><strong>事务实现原理</strong></p>
<blockquote>
<p>事务的 隔离性 由 锁机制 实现。</p>
<p>事务的原子性、一致性和持久性由redo 日志和undo 日志来保证。</p>
</blockquote>
<h2 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h2><blockquote>
<p>MVCC是为了解决 读-写 之间阻塞的问题（排他锁会阻塞读操作），写操作还是需要加锁（Next-Key Lock）。</p>
<p>如果没有MVCC，那么修改数据的操作会加排它锁，其它的读写操作都会阻塞，这样的话效率会比较低。</p>
<p>MVCC通过Undo Log + Read View进行数据读取。</p>
<ul>
<li>Undo Log保存了历史快照。</li>
<li>Read View规则判断当前版本的数据是否可见。</li>
</ul>
</blockquote>
<p><strong>快照读与当前读</strong></p>
<p>快照读：</p>
<blockquote>
<p>快照读读取的是快照数据。</p>
<ul>
<li>不加锁的简单的 SELECT 都属于快照读，即不加锁的非阻塞读。</li>
</ul>
<p>快照读的实现是基于MVCC，它在很多情况下，避免了加锁操作，降低了开销。</p>
<ul>
<li>既然是基于多版本，那么快照读可能读到的 并不一定是数据的最新版本，而 有可能是之前的历史版本。</li>
</ul>
<p>快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读。</p>
</blockquote>
<pre><code class="sql">SELECT * FROM player WHERE ...
</code></pre>
<p>当前读:</p>
<blockquote>
<p>读取的是记录的 最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。</p>
<p><strong>加锁的 SELECT，或者对数据进行增删改都会进行当前读</strong>。</p>
</blockquote>
<pre><code class="sql">SELECT * FROM student LOCK IN SHARE MODE; # 共享锁
SELECT * FROM student FOR UPDATE; # 排他锁
INSERT INTO student values ... # 排他锁
DELETE FROM student WHERE ... # 排他锁
UPDATE student SET ... # 排他锁
</code></pre>
<p><strong>Undo Log版本链</strong></p>
<p>InnoDB 聚簇索引记录中包含 3 个隐藏的列：</p>
<blockquote>
<p><code>DB_ROW_ID</code>（隐藏的自增 ID）：</p>
<ul>
<li>如果表没有主键，InnoDB 会自动按 ROW ID 产生一个聚集索引树。</li>
</ul>
<p><code>DB_TRX_ID</code>（事务ID）：</p>
<ul>
<li>记录最近更新这条行记录的事务 ID，大小为 6 个字节。</li>
</ul>
<p><code>DB_ROLL_PTR</code>（回滚指针） ：</p>
<ul>
<li>指向该行回滚段的指针，大小为 7 个字节。</li>
<li>该行记录上所有旧版本，在 undo 中都通过链表的形式组织。</li>
</ul>
</blockquote>
<p><img src="/images/aed1d3bf878648919bd2851f120e1995.png" alt="在这里插入图片描述"></p>
<blockquote>
<p>每次对记录进行改动，都会记录一条undo日志，每条undo日志都有一个<code>roll_pointer</code>属性。</p>
<p>将这些undo日志都连起来，串成一个链表，这个链表称之为 版本链。</p>
<ul>
<li>版本链的 头节点 就是当前记录 最新的值。</li>
<li>每个版本中包含生成该版本时对应的 事务id。</li>
</ul>
</blockquote>
<p><img src="/images/0604c2ecadc9493d8c73c3713846b8e2.png" alt="在这里插入图片描述"></p>
<p><strong>ReadView</strong></p>
<blockquote>
<p>ReadView就是事务在使用MVCC机制进行快照读操作时产生的读视图。</p>
<p><strong>判断一下版本链中的哪个版本是当前事务可见的，这是ReadView要解决的主要问题</strong>。</p>
</blockquote>
<p>ReadView主要包含4个内容：</p>
<blockquote>
<p><code>creator_trx_id</code>：</p>
<ul>
<li>创建这个 Read View 的事务 ID。</li>
</ul>
<p><code>trx_ids</code>：</p>
<ul>
<li>在生成ReadView时当前系统中 活跃的 读写事务的事务id列表(活跃：启动了但还没提交)。</li>
</ul>
<p><code>up_limit_id</code>：</p>
<ul>
<li>活跃的 事务中 最小的事务 ID。</li>
</ul>
<p><code>low_limit_id</code>：</p>
<ul>
<li>表示生成ReadView时系统中应该分配给下一个事务的id 值。</li>
</ul>
</blockquote>
<p>ReadView规则:</p>
<blockquote>
<p>如果被访问版本的 <code>trx_id</code> 属性值与 ReadView 中的 <code>creator_trx_id</code> 值 相同:</p>
<ul>
<li>意味着当前事务在访问它自己修改过的记录，所以该版本可以被当前事务访问。</li>
</ul>
<p>如果被访问版本的 <code>trx_id</code> 属性值 小于 ReadView 中的 <code>up_limit_id</code> 值:</p>
<ul>
<li>表明生成该版本的事务在当前事务生成ReadView前已经提交，所以该版本可以被当前事务访问。</li>
</ul>
<p>如果被访问版本的 <code>trx_id</code> 属性值 大于或等于 ReadView中的 <code>low_limit_id</code> 值:</p>
<ul>
<li>表明生成该版本的事务在当前事务生成ReadView后才开启，所以该版本 不可以 被当前事务访问。</li>
</ul>
<p>如果被访问版本的 <code>trx_id</code> 属性值在 ReadView 的 <code>up_limit_id</code> 和 <code>low_limit_id</code> 之间。</p>
<p>需要判断一下<code>trx_id</code>属性值是不是在<code>trx_ids</code> 列表中。</p>
<ul>
<li><p>如果在，说明创建ReadView时生成该版本的事务还是活跃的，该版本不可以被访问。</p>
</li>
<li><p>如果不在，说明创建ReadView时生成该版本的事务已经被提交，该版本可以被访问。</p>
</li>
</ul>
</blockquote>
<p><strong>MVCC整体操作流程</strong></p>
<blockquote>
<p>首先 获取事务自己的版本号，也就是事务 ID。</p>
<p>获取 ReadView。</p>
<p>查询得到的数据，然后与 ReadView 中的事务版本号进行比较。</p>
<p>如果不符合 ReadView 规则，就需要从 Undo Log 中获取历史快照。</p>
<p>最后 返回符合规则的数据。</p>
<p>如果某个版本的数据对当前事务不可见的话，那就顺着版本链找到下一个版本的数据，继续按照上边的步骤判断可见性。</p>
<ul>
<li>依此类推，直到版本链中的最后一个版本。</li>
</ul>
<p>如果最后一个版本也不可见的话，那么就意味着该条记录对该事务完全不可见，查询结果就不包含该记录。</p>
<p><strong>READ COMMITTED事务，在每次查询开始时都会生成一个独立的ReadView。</strong></p>
<p><strong>REPEATABLE READ事务，只会在第一次执行查询语句时生成一个ReadView，之后的查询就不会重复生成了。</strong></p>
</blockquote>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p><strong>索引分类</strong></p>
<p>单列索引：基于单个字段建立的索引。</p>
<blockquote>
<p>唯一索引：</p>
<ul>
<li>指索引中的索引节点值不允许重复，一般配合唯一约束使用。</li>
</ul>
<p>主键索引：</p>
<ul>
<li>一种特殊的唯一索引，和普通唯一索引的区别在于不允许有空值。</li>
</ul>
<p>普通索引：</p>
<ul>
<li>通过<code>KEY、INDEX</code>关键字创建的索引。</li>
</ul>
</blockquote>
<p>多列索引：由多个字段组合建立的索引。</p>
<p>聚簇索引和非聚簇索引:</p>
<blockquote>
<p>聚簇索引（主键索引）：</p>
<ul>
<li>叶子节点存放的是实际数据，所有完整的用户数据都存放在聚簇索引的叶子节点。</li>
</ul>
<p>非聚簇索引（二级索引）：</p>
<ul>
<li>叶子节点存放的是主键值，而不是实际数据。</li>
</ul>
</blockquote>
<p><img src="/images/2529502-20220105141617752-154425145.jpg" alt="B+树索引"></p>
<p>二级索引：</p>
<blockquote>
<p>使用 二级索引 字段作为条件查询的时候，如果要查询的数据都在 聚簇索引 的叶子节点里，需要检索两颗B+树：</p>
<ul>
<li>先在 二级索引 的 B+ 树找到对应的叶子节点，获取主键值。</li>
<li>然后用上一步获取的主键值，在 聚簇索引 中的 B+ 树检索到对应的叶子节点，然后获取要查询的数据。</li>
</ul>
<p>这个过程叫做<strong>回表</strong>。</p>
</blockquote>
<p>全文索引：</p>
<blockquote>
<p>类似于<code>ES、Solr</code>搜索中间件中的分词器。</p>
<p>只能创建在<code>CHAR、VARCHAR、TEXT</code>等这些文本类型字段上，而且使用全文索引查询时，条件字符数量必须大于<code>3</code>才生效。</p>
</blockquote>
<p><strong>哪些情况下适合建索引</strong></p>
<blockquote>
<p>作为where条件语句查询的字段。</p>
<p>关联字段需要建立索引。</p>
<p>排序字段可以建立索引。</p>
<p>分组字段可以建立索引。</p>
<p>统计字段可以建立索引，如<code>count()，max()</code>。</p>
</blockquote>
<p><strong>哪些情况下不适合建索引</strong> 　</p>
<blockquote>
<p>频繁更新的字段不适合建立索引。</p>
<p>where条件中用不到的字段不适合建立索引。</p>
<p>表数据比较少的不需要建索引。</p>
<p>数据重复且发布比较均匀的的字段不适合建索引。</p>
<p>参与列计算的列不适合建索引。</p>
</blockquote>
<p><strong>索引覆盖</strong></p>
<blockquote>
<p>要查询的列，在使用的索引中已经包含，这种情况称之为索引覆盖。</p>
</blockquote>
<p><strong>索引结构</strong></p>
<blockquote>
<p><code>InnoDB</code>中使用了<strong>B+树</strong>来实现索引。</p>
<p><code>InnoDB</code>的整数字段建立索引为例：</p>
<ul>
<li>一个页默认<code>16kb</code>，整数（<code>bigint</code>）字段的长度为<code>8B</code>，另外还跟着<code>6B</code>的指向其子树的指针，这意味着一个索引页可以存储接近<code>1200</code>条数据(<code>16kb/14B ≈ 1170</code>)。</li>
<li>如果这颗<strong>B+树</strong>高度为<code>4</code>，就可以存<code>1200</code>的<code>3</code>次方的值，差不多<code>17</code>亿条数据。</li>
</ul>
<p>考虑到树根节点总是在内存中的，树的第二层很大概率也在内存中，所以一次搜索最多只需要访问<code>2</code>次磁盘<code>IO</code>。</p>
<p>假设<code>1</code>亿数据量的表，根据主键<code>id</code>建立了<code>B+</code>树索引，搜索<code>id=2699</code>的数据，流程如下：</p>
<ul>
<li>内存中直接获取树根索引页，对树根索引页内的目录进行二分查找，定位到第二层的索引页。</li>
<li>内存中直接获取第二层的索引页，对索引页内的目录进行二分查找，定位到第三层的索引页。</li>
<li>从磁盘加载第三层的索引页到内存中，对索引页内的目录进行二分查找，定位到第四层数据页。</li>
<li>从磁盘加载第四层的数据页到内存中，数据页变成缓存页，对缓存页中的目录进行二分查找，定位到具体的行数据。</li>
</ul>
</blockquote>
<p><img src="/images/image-20231023192413070.png" alt="image-20231023192413070"></p>
<p><strong>B+树</strong></p>
<p><img src="/images/dd076212a7637b9032c97a615c39dcd7.png" alt="图片"></p>
<blockquote>
<p>B+ 树与 B 树差异点：</p>
<ul>
<li><p>叶子节点（最底部的节点）才会存放实际数据（索引+记录），非叶子节点只会存放索引。</p>
</li>
<li><p>所有索引都会在叶子节点出现，叶子节点之间构成一个有序链表。</p>
<ul>
<li>Innodb 的 B+ 树的叶子节点之间是用 双向链表 进行连接，既能向右遍历，也能向左遍历。</li>
</ul>
</li>
<li><p>非叶子节点的索引也会同时存在在子节点中，并且是在子节点中所有索引的最大（或最小）。</p>
</li>
<li><p>非叶子节点中有多少个子节点，就有多少个索引。</p>
</li>
</ul>
<p>B+ 树的非叶子节点不存放实际的记录数据，仅存放索引。</p>
<ul>
<li>因此数据量相同的情况下，相比存储即存索引又存记录的 B 树，B+树的非叶子节点可以存放更多的索引。</li>
</ul>
<p>因此 B+ 树可以比 B 树更 矮胖 ，查询底层节点的磁盘 I&#x2F;O次数会更少。</p>
<p>MyISAM 存储引擎：</p>
<ul>
<li>B+ 树索引的叶子节点保存数据的物理地址，即用户数据的指针。</li>
</ul>
<p>InnoDB 存储引擎：</p>
<ul>
<li>B+ 树索引的叶子节点保存数据本身。</li>
</ul>
</blockquote>
<p><strong>为什么使用B+树而不使用跳表？</strong></p>
<blockquote>
<p>B+树 是多叉树结构，每个结点都是一个16k的数据页，能存放较多索引信息。</p>
<ul>
<li>三层左右可以存储<code>2kw</code>左右的数据，查询一次数据，如果这些数据页都在磁盘里，最多需要查询<strong>三次磁盘IO</strong>。</li>
</ul>
<p><strong>跳表</strong>是链表结构，一条数据一个结点，如果最底层要存放<code>2kw</code>数据，且每次查询都要能达到<strong>二分查找</strong>的效果，<code>2kw</code>大概在<code>2的24次方</code>左右，所以，跳表大概高度在<strong>24层</strong>左右。</p>
<ul>
<li>最坏情况下，这24层数据会分散在不同的数据页里，也即是查一次数据会经历<strong>24次磁盘IO</strong>。</li>
</ul>
<p>针对写操作，B+树需要拆分合并索引数据页，跳表则独立插入，并根据随机函数确定层数，没有旋转和维持平衡的开销，因此<strong>跳表的写入性能会比B+树要好。</strong></p>
</blockquote>
<p><strong>为什么Redis有序集合底层选择跳表而非B+树</strong></p>
<blockquote>
<p>Redis是基于内存的数据库，因此不需要考虑磁盘IO。</p>
<ul>
<li>B+树在数据写入时，存在拆分和合并数据页的开销，目的是为了保持树的平衡。</li>
<li>跳表在数据写入时，只需要通过随机函数生成当前节点的层数即可，然后更新每一层索引，往其中加入一个节点，相比于B+树而言，少了旋转平衡带来的开销。</li>
</ul>
<p>由于跳表的查询复杂度在O<code>(logn)</code>，因此Redis中Zset数据类型底层结合使用<code>skiplist</code>和<code>hash</code>，用空间换时间，利用跳表支持范围查询和有序查询，利用Hash支持精确查询。</p>
</blockquote>
<p><strong>索引下推ICP(Index Condition Pushdown)</strong></p>
<blockquote>
<p>一张<code>user</code>表，有<code>age_name</code>的联合索引。</p>
<p>执行查询<code>explain SELECT * from user where age &gt;10 and name = &#39;a&#39;</code>。</p>
<ul>
<li>看见<code>Extra</code>中显示了<code>Using index condition</code>，表示出现了<strong>索引下推</strong>。</li>
</ul>
<p>ICP流程：</p>
<ul>
<li>联合索引首先通过条件找到所有<code>age&gt;10</code>的数据，根据联合索引中已经存在的<code>name</code>数据进行过滤，找到符合条件的数据。</li>
</ul>
</blockquote>
<p><strong>索引合并</strong></p>
<blockquote>
<p>在MySQL 5.1之后进行引入，它可以在多个索引上进行查询，并将结果合并返回。</p>
</blockquote>
<p><strong>CBO</strong></p>
<p>CBO（Cost-Based Optimizer，基于成本的优化器）。</p>
<blockquote>
<p>优化器的选择是基于成本（cost），哪个索引的成本越低，优先使用哪个索引。</p>
</blockquote>
<p>一条 SQL 的计算成本计算如下：</p>
<pre><code class="java">Cost  = Server Cost + Engine Cost
      = CPU Cost + IO Cost
</code></pre>
<blockquote>
<p>CPU Cost：</p>
<ul>
<li>表示计算的开销，比如索引键值的比较、记录值的比较、结果集的排序……这些操作都在 Server 层完成。</li>
</ul>
<p>IO Cost：</p>
<ul>
<li>计算读取内存 IO 开销以及读取磁盘 IO 的开销。</li>
</ul>
</blockquote>
<h2 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a>Explain</h2><p>table列:</p>
<blockquote>
<p>表示 explain 的一行正在访问哪个表。</p>
<p>当 from 子句中有子查询时，table列是 <code>&lt;derivenN&gt;</code> 格式：</p>
<ul>
<li>表示当前查询依赖 id&#x3D;N 的查询，先执行 id&#x3D;N 的查询。</li>
<li>当有 union 时，UNION RESULT 的 table 列的值为<code>&lt;union1,2&gt;</code>，1和2表示参与 union 的 select 行id。</li>
</ul>
</blockquote>
<p>id列：</p>
<blockquote>
<p>id列的编号是 select 的序列号，有几个 select 就有几个id，并且id的顺序是按 select 出现的顺序增长的。</p>
<ul>
<li>id列越大执行优先级越高，id相同则从上往下执行，id为NULL最后执行。</li>
</ul>
</blockquote>
<p>select_type列：</p>
<blockquote>
<p><strong>SIMPLE</strong>：</p>
<ul>
<li>查询语句中不包含UNION或者子查询的查询都算作是SIMPLE类型。</li>
</ul>
<p><strong>PRIMARY</strong>：</p>
<ul>
<li>对于包含UNION、UNION ALL或者子查询的大查询来说，它是由几个小查询组成。</li>
<li>其中最左边的那个查询的<code>select_type</code>值就是PRIMARY。</li>
</ul>
</blockquote>
<p>type列：</p>
<blockquote>
<p>从最优到最差分别为：<code>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</code>。</p>
<ul>
<li>一般来说，得保证查询达到range级别，最好达到ref。</li>
</ul>
<p><strong>eq_ref</strong>：</p>
<ul>
<li><code>primary key</code> 或 <code>unique key</code> 索引使用，最多只会返回一条符合条件的记录。</li>
</ul>
<p><strong>ref</strong>:</p>
<ul>
<li>当通过普通二级索引来查询某个表，那么对该表的访问方法就可能是ref。</li>
<li>相比 <code>eq_ref</code>，不使用唯一索引，可能会找到多个符合条件的行。</li>
</ul>
<p><strong>ref_or_null</strong>：</p>
<ul>
<li>当对普通二级索引查询，该索引列的值可以是NULL值时，那么对该表的访问方法就可能是<code>ref_or_null</code></li>
</ul>
<p><strong>range</strong>：</p>
<ul>
<li>范围扫描通常出现在 <code>in(), between ,&gt; ,&lt;, &gt;=</code> 等操作中。</li>
<li>使用一个索引来检索给定范围的行。</li>
</ul>
<p><strong>index</strong>:</p>
<ul>
<li>当使用索引覆盖，但需要扫描全部的索引记录时，该表的访问方法就是index。</li>
</ul>
<p><strong>index_merge：</strong></p>
<ul>
<li>一般情况下对于某个表的查询只能使用到一个索引，但在某些场景下可以使用多种索引合并的方式来执行查询。</li>
</ul>
<p><strong>ALL：</strong></p>
<ul>
<li>全表扫描。</li>
</ul>
</blockquote>
<p>possible_keys列：</p>
<blockquote>
<p>显示查询可能使用哪些索引来查找。</p>
</blockquote>
<p>key_len列:</p>
<blockquote>
<p>显示了索引里使用的字节数，通过这个值可以算出具体使用了索引中的哪些列。</p>
<p>key_len计算规则如下：</p>
<p>字符串：</p>
<ul>
<li>char(n)：n字节，varchar(n)：2字节，如果是utf-8，则长度 3n + 2</li>
</ul>
<p>数值类型：</p>
<ul>
<li>tinyint：1字节，smallint：2字节，int：4字节，bigint：8字节</li>
</ul>
<p>　 </p>
<p>时间类型：</p>
<ul>
<li>date：3字节，timestamp：4字节，datetime：8字节</li>
</ul>
</blockquote>
<p>rows列：</p>
<blockquote>
<p>读取并检测的行数，注意这个不是结果集里的行数。</p>
<ul>
<li><p>如果使用全表扫描查询时，执行计划的rows列就代表预计需要扫描的行数。</p>
</li>
<li><p>如果使用索引查询时，执行计划的rows列就代表预计扫描的索引记录行数。</p>
</li>
</ul>
</blockquote>
<p>ref列：</p>
<blockquote>
<p>显示了在key列记录的索引中，表查找值所用到的列或常量，常见的有：const（常量），字段名。</p>
<ul>
<li>ref列展示的就是与索引列作等值匹配的值什么，比如只是一个常数或者是某个列。</li>
</ul>
</blockquote>
<p>Extra列：</p>
<blockquote>
<p><strong>Using index</strong></p>
<ul>
<li>查询的列被索引覆盖，并且where筛选条件是索引的前导列。</li>
<li>一般是使用了覆盖索引(索引包含了所有查询的字段)。</li>
</ul>
<p><strong>Using where</strong></p>
<ul>
<li>使用全表扫描来执行对某个表的查询，并且该语句的WHERE子句中有针对该表的搜索条件时。</li>
</ul>
<p><strong>Using where Using index</strong></p>
<ul>
<li>查询的列被索引覆盖，并且where筛选条件是索引列之一但是不是索引的前导列。<ul>
<li>意味着无法直接通过索引查找来查询到符合条件的数据。</li>
</ul>
</li>
</ul>
<p><strong>Using index condition</strong></p>
<ul>
<li>查询的列不完全被索引覆盖，where条件中是一个前导列的范围。</li>
</ul>
<p><strong>Using temporary</strong></p>
<ul>
<li>在执行DISTINCT、GROUP BY、UNION等子句的查询时，如果不能利用索引来完成查询，MySQL通过建立内部的临时表来执行查询。</li>
</ul>
<p><strong>Using filesort</strong></p>
<ul>
<li>会对结果使用一个外部索引排序，而不是按索引次序从表里读取行。</li>
</ul>
</blockquote>
<h1 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h1><blockquote>
<p><code>MySQL</code>日志主要包括错误日志、查询日志、慢查询日志、事务日志、二进制日志。</p>
</blockquote>
<p><strong>binlog</strong></p>
<blockquote>
<p><code>binlog</code>用于记录数据库执行的写入性操作(不包括查询)信息，以二进制的形式保存在磁盘中。</p>
<ul>
<li><code>binlog</code>是<code>mysql</code>的逻辑日志，并且由<code>Server</code>层进行记录，使用任何存储引擎的<code>mysql</code>数据库都会记录<code>binlog</code>日志。</li>
<li>逻辑日志：<strong>可以理解为记录的是sql语句</strong>。</li>
<li>物理日志：<strong>因为<code>mysql</code>数据最终是保存在数据页中的，物理日志记录的就是数据页变更</strong>。</li>
</ul>
<p><code>binlog</code>是通过追加的方式进行写入的，通过<code>max_binlog_size</code>参数设置每个<code>binlog</code>文件的大小，当文件大小达到给定值之后，会生成新的文件来保存日志。</p>
</blockquote>
<p>binlog使用场景:</p>
<blockquote>
<p><strong>主从复制和数据恢复</strong></p>
</blockquote>
<p>binlog刷盘时机：</p>
<blockquote>
<p>对于<code>InnoDB</code>存储引擎而言，只有在事务提交时才会记录<code>biglog</code>，此时记录还在内存中。</p>
<p><code>biglog</code>什么时候刷到磁盘中？</p>
<ul>
<li><code>mysql</code>通过<code>sync_binlog</code>参数控制<code>biglog</code>的刷盘时机，取值范围是<code>0-N</code>：<ul>
<li>0：不去强制要求，由系统自行判断何时写入磁盘。</li>
<li>1：每次<code>commit</code>的时候都要将<code>binlog</code>写入磁盘。</li>
<li>N：每N个事务，才会将<code>binlog</code>写入磁盘。</li>
</ul>
</li>
</ul>
</blockquote>
<p>binlog日志格式：</p>
<blockquote>
<p>STATMENT:</p>
<ul>
<li><p>基于SQL语句的复制，每一条会修改数据的sql语句会记录到<code>binlog</code>中。</p>
</li>
<li><p>优点：不需要记录每一行的变化，减少了<code>binlog</code>日志量，节约了IO, 从而提高了性能；</p>
</li>
<li><p>缺点：在某些情况下会导致主从数据不一致，比如执行<code>sysdate()、slepp()</code>等。</p>
</li>
</ul>
<p>ROW:</p>
<ul>
<li><p>基于行的复制，记录哪条数据被修改了。</p>
</li>
<li><p>缺点：会产生大量的日志，<code>alter table</code>的时会让日志暴涨。</p>
</li>
</ul>
<p>MIXED：</p>
<ul>
<li>基于STATMENT和ROW两种模式的混合复制。</li>
<li>一般的复制使用STATEMENT模式保存<code>binlog</code>，对于STATEMENT模式无法复制的操作使用ROW模式保存<code>binlog</code>。</li>
</ul>
<p>在 MySQL 5.7.7之前，默认的格式是<code>STATEMENT</code>，MySQL 5.7.7之后，默认值是<code>ROW</code>。</p>
</blockquote>
<p><strong>redo log</strong></p>
<blockquote>
<p><strong>记录事务对数据页做了哪些修改</strong></p>
<p><code>redo log</code>包括两部分：</p>
<ul>
<li>内存中的日志缓冲(<code>redo log buffer</code>)。</li>
<li>磁盘上的日志文件(<code>redo log file</code>)。</li>
</ul>
<p><code>mysql</code>每执行一条<code>DML</code>语句，先将记录写入<code>redo log buffer</code>，后续某个时间点再一次性将多个操作记录写到<code>redo log file</code>。</p>
<ul>
<li>这种<strong>先写日志，再写磁盘</strong>的技术就是<code>WAL(Write-Ahead Logging)</code> 技术。</li>
</ul>
</blockquote>
<img src="/images/ef735ae0efa14f36b9037f17acf8fc81.png" alt="在这里插入图片描述" style="zoom:80%;" />

<p><code>mysql</code>支持三种将<code>redo log buffer</code>写入<code>redo log file</code>的时机，通过<code>innodb_flush_log_at_trx_commit</code>参数配置。</p>
<table>
<thead>
<tr>
<th>参数值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0（延迟写）</td>
<td>事务提交时不会将<code>redo log buffer</code>中日志写入到<code>os buffer</code>，而是每秒写入<code>os buffer</code>并调用<code>fsync()</code>写入到<code>redo log file</code>中，当系统崩溃，会丢失1秒钟的数据。</td>
</tr>
<tr>
<td>1（实时写，实时刷）</td>
<td>事务每次提交都会将<code>redo log buffer</code>中的日志写入<code>os buffer</code>并调用<code>fsync()</code>刷到<code>redo log file</code>中，因为每次提交都写入磁盘，IO的性能较差。</td>
</tr>
<tr>
<td>2（实时写，延迟刷）</td>
<td>每次提交都仅写入到<code>os buffer</code>，然后是每秒调用<code>fsync()</code>将<code>os buffer</code>中的日志写入到<code>redo log file</code>。</td>
</tr>
</tbody></table>
<p>redo log记录形式：</p>
<blockquote>
<p><code>redo log</code>采用了大小固定，循环写入的方式，当写到结尾时，会回到开头循环写日志。</p>
</blockquote>
<p>redo log与binlog区别:</p>
<table>
<thead>
<tr>
<th></th>
<th>redo log</th>
<th>binlog</th>
</tr>
</thead>
<tbody><tr>
<td>文件大小</td>
<td><code>redo log</code>的大小是固定的。</td>
<td><code>binlog</code>可通过配置参数<code>max_binlog_size</code>设置每个<code>binlog</code>文件的大小。</td>
</tr>
<tr>
<td>实现方式</td>
<td><code>redo log</code>是<code>InnoDB</code>引擎层实现的，并不是所有引擎都有。</td>
<td><code>binlog</code>是<code>Server</code>层实现的，所有引擎都可以使用 <code>binlog</code>日志</td>
</tr>
<tr>
<td>记录方式</td>
<td>redo log 采用循环写的方式记录，当写到结尾时，会回到开头循环写日志。</td>
<td>binlog 通过追加的方式记录，当文件大小大于给定值后，后续的日志会记录到新的文件上</td>
</tr>
<tr>
<td>适用场景</td>
<td><code>redo log</code>适用于崩溃恢复(crash-safe)</td>
<td><code>binlog</code>适用于主从复制和数据恢复</td>
</tr>
</tbody></table>
<p><strong>undo log</strong></p>
<blockquote>
<p><code>undo log</code>主要记录了数据的逻辑变化。</p>
<p>比如一条<code>INSERT</code>语句，对应一条<code>DELETE</code>的<code>undo log</code>，对于每个<code>UPDATE</code>语句，对应一条相反的<code>UPDATE</code>的<code>undo log</code>，这样在发生错误时，就能回滚到事务之前的数据状态。</p>
</blockquote>
<h1 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h1><p><strong>锁结构</strong></p>
<blockquote>
<p>当一个事务想对这条记录做改动时，会看看内存中有没有与这条记录关联的锁结构。</p>
<ul>
<li>当没有的时候就会在内存中生成一个锁结构与之关联。</li>
</ul>
<p><code>锁结构</code>信息：</p>
<ul>
<li><strong>trx信息</strong>：这个锁结构是哪个事务生成的。</li>
<li><strong>is_waiting</strong> : 当前事务是否在等待。</li>
</ul>
</blockquote>
<img src="/images/dfd4937cf9de40c489713dfa73403312.png" alt="在这里插入图片描述" style="zoom:80%;" />

<p><strong>锁分类</strong></p>
<p>读锁、写锁：</p>
<blockquote>
<p><strong>读锁</strong>：</p>
<ul>
<li>共享锁，用S表示。<ul>
<li>针对同一份数据，多个事务的读操作可以同时进行而不会互相影响，相互不阻塞的。</li>
</ul>
</li>
</ul>
<p><strong>写锁</strong>：</p>
<ul>
<li>排他锁，用X表示。<ul>
<li>当前写操作没有完成前，它会阻断其他写锁和读锁。</li>
<li>这样就能确保在给定的时间里，只有一个事务能执行写入，并防止其他用户读取正在写入的同一资源。</li>
</ul>
</li>
</ul>
</blockquote>
<p>对读取的记录加S锁：</p>
<pre><code class="sql">SELECT ... LOCK IN SHARE MODE;
# 或
SELECT ... FOR SHARE; # (8.0新增语法)
</code></pre>
<p>对读取的记录加X锁：</p>
<pre><code class="sql">SELECT ... FOR UPFATE;
</code></pre>
<p>表锁:</p>
<blockquote>
<p><code>LOCK TABLES t READ</code>:</p>
<ul>
<li>对表t加表级别的<code>S锁</code>。</li>
</ul>
<p><code>LOCK TABLES t WRITE</code>:</p>
<ul>
<li>对表t加表级别的<code>X锁</code>。</li>
</ul>
</blockquote>
<p>意向锁：</p>
<blockquote>
<p>有两个事务，分别是T1和T2，其中T2试图在该表级别上应用共享或排它锁：</p>
<ul>
<li>如果没有意向锁，T2就需要去检查各个页或行是否存在锁。</li>
<li>如果存在意向锁，那么此时就会受到由T1控制的表级别意向锁的阻塞。</li>
</ul>
<p>如果事务想要获得数据表中某些记录的共享锁，需要在数据表上添加<code>意向共享锁</code>。</p>
<p>如果事务想要获得数据表中某些记录的排他锁，需要在数据表上添加<code>意向排他锁</code>。</p>
<ul>
<li>意向锁会告诉其他事务已经有人锁定了表中的某些记录。</li>
</ul>
<p><strong>在为数据行加共享&#x2F;排他锁之前</strong>，<strong>InooDB会先获取该数据行所在数据表的对应意向锁</strong>。</p>
</blockquote>
<p>元数据锁（MDL锁）：</p>
<blockquote>
<p>MDL 的作用是 保证读写的正确性。</p>
<ul>
<li>如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，增加了一列，那么查询线程拿到的结果跟表结构对不上。</li>
</ul>
<p>当对一个表做增删改查操作的时候，加 MDL读锁。</p>
<p>当要对表做结构变更操作的时候，加 MDL 写锁。</p>
</blockquote>
<p>行锁：</p>
<blockquote>
<p>行锁(Row Lock)也称为记录锁，就是锁住某一行（某条记录Row)。</p>
</blockquote>
<p>间隙锁（Gap Locks）:</p>
<blockquote>
<p>MySQL解决幻读问题方案有两种：</p>
<ul>
<li>使用 MVCC。</li>
<li>采用加锁（Gap Locks）。</li>
</ul>
<p>图中id值为8的记录加了gap锁，意味着 <code>不允许别的事务在id值为8的记录前边的间隙插入新记录</code>。</p>
<ul>
<li>id列的值<code>(3, 8)</code>这个区间的新记录是不允许立即插入的。</li>
</ul>
</blockquote>
<p><img src="/images/5e806eee00694701910a111bda8ac2bc.png" alt="在这里插入图片描述"></p>
<p>临键锁（Next-Key Locks）:</p>
<blockquote>
<p>既想锁住某条记录，又想阻止其他事务在该记录前边的间隙插入新记录，InnoDB就提出了Next-Key Locks。</p>
<ul>
<li>它是在 可重复读 的情况下使用的数据库锁，Innodb默认的锁就是<code>Next-Key Locks</code>。</li>
</ul>
</blockquote>
<hr>
<blockquote>
<p>1、update 命令会施加一个 X 型记录锁，X 型记录锁是写写互斥的。</p>
<ul>
<li>如果 A 事务对 goods 表中 id &#x3D; 1 的记录行加了记录锁，B 事务想要对这行记录加记录锁就会被阻塞。</li>
</ul>
<p>2、insert 命令会施加一个插入意向锁，但插入意向锁是互相兼容的。</p>
<ul>
<li>如果 A 事务向 order 表 insert 一条记录，不会影响 B 事务 insert 一条记录。</li>
</ul>
</blockquote>
<p><strong>select……for update锁表还是锁行</strong></p>
<blockquote>
<p>如果查询条件用了<strong>索引&#x2F;主键</strong>，<code>select ..... for update</code> 会进行行锁。</p>
<p>如果是普通字段（<strong>没有索引&#x2F;主键</strong>）， <code>select ..... for update</code> 会进行锁表。</p>
</blockquote>
<p><strong>如何有效的避免死锁的发生</strong></p>
<blockquote>
<p>设置事务等待锁的超时时间：</p>
<ul>
<li>当一个事务的等待时间超过该值后，就对这个事务进行回滚，于是锁就释放了，另一个事务就可以继续执行了。</li>
<li>在 InnoDB 中，参数 <code>innodb_lock_wait_timeout</code> 是用来设置超时时间的，默认值时 50 秒。</li>
</ul>
<p>开启主动死锁检测：</p>
<ul>
<li>主动死锁检测在发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。</li>
<li>将参数 <code>innodb_deadlock_detect</code> 设置为 on，表示开启这个逻辑，默认就开启。</li>
</ul>
<p>修改数据库隔离级别为RC：</p>
<ul>
<li>MySql默认级别为RR，RC没有间隙锁<code>Gap Lock</code>和组合锁<code>Next-Key Lock</code>，能一定程度的避免死锁的发生。</li>
</ul>
<p>尽量少使用当前读<code>for update</code>，数据更新时尽量使用主键。</p>
</blockquote>
<h1 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h1><p><strong>Buffer Pool</strong></p>
<blockquote>
<p><code>Buffer Pool</code>作为缓存页。</p>
<ul>
<li><code>MySQL</code>数据以页为单位，每页默认<code>16KB</code>，称为数据页，在<code>Buffer Pool</code>里面会划分出若干<strong>个缓存页</strong>与数据页对应。</li>
</ul>
<p>缓存页的元数据信息（描述数据）：</p>
<ul>
<li>它与缓存页一一对应，包含一些所属表空间、数据页的编号、<code>Buffer Pool</code>中的地址等。</li>
</ul>
<p>后续对数据的增删改查都在<code>Buffer Pool</code>里操作：</p>
<ul>
<li>查询：从磁盘加载到缓存，后续直接查缓存。</li>
<li>插入：直接写入缓存。</li>
<li>更新删除：缓存中存在直接更新，不存在加载数据页到缓存更新。</li>
</ul>
</blockquote>
<p>缓存页哈希表:</p>
<blockquote>
<p>如何在<code>Buffer Pool</code>里快速定位到对应的缓存页？</p>
<ul>
<li><p>使用哈希表来缓存它们间的映射关系，时间复杂度是<code>O(1)</code>。</p>
</li>
<li><p><strong>表空间号+数据页号</strong>，作为一个<code>key</code>，缓存页的地址作为<code>value</code>。</p>
</li>
<li><p>每次加载数据页到空闲缓存页时，就写入一条映射关系到<strong>缓存页哈希表</strong>中。</p>
</li>
</ul>
<p>后续的查询，就可以通过<strong>缓存页哈希表</strong>路由定位了。</p>
</blockquote>
<p>Free链表：</p>
<blockquote>
<p>使用链表结构，把空闲缓存页的<strong>描述数据</strong>放入链表中，这个链表称为<code>free</code>链表。</p>
<ul>
<li>往<strong>描述数据</strong>与<strong>缓存页</strong>写入数据后，就将该<strong>描述数据</strong>移出<code>free</code>链表。</li>
</ul>
</blockquote>
<img src="/images/image-20231025101205613.png" alt="image-20231025101205613" style="zoom:90%;" />

<p>Flush链表:</p>
<blockquote>
<p>缓存页被更新，就将它的<strong>描述数据</strong>加入<code>flush</code>链表。</p>
<p>后续异步线程都从<code>flush</code>链表刷缓存页，当<code>Buffer Pool</code>内存不足时，也会优先刷<code>flush</code>链表里的缓存页。</p>
</blockquote>
<p>LRU链表:</p>
<blockquote>
<p>借鉴<code>LRU</code>算法思想，把最少使用的缓存页淘汰（命中率低），提供<code>LRU</code>链表出来。</p>
<ul>
<li>当<code>free</code>链表为空的时候，直接淘汰<code>LRU</code>链表尾部缓存页即可。</li>
</ul>
</blockquote>
<p><strong>ChangeBuffer</strong></p>
<blockquote>
<p>ChangeBuffer是InnoDB缓存区的一种特殊的数据结构，当用户执行SQL对非唯一索引进行更改时，如果索引对应的数据页不在缓存中时，InnoDB不会直接加载磁盘数据到缓存数据页中，而是缓存对这些更改操作。</p>
<ul>
<li>这些更改操作可能由插入、更新或删除操作(DML)触发。</li>
</ul>
</blockquote>
<hr>
<blockquote>
<p>ChangeBuffer用于存储SQL变更操作，比如Insert&#x2F;Update&#x2F;Delete等SQL语句。</p>
<p>ChangeBuffer中的每个变更操作都有其对应的数据页，并且该数据页未加载到缓存中。</p>
<p>当ChangeBufferd中变更操作对应的数据页加载到缓存中后，InnoDB会把变更操作Merge到数据页上。</p>
<p>InnoDB会定期加载ChangeBuffer中操作对应的数据页到缓存中，并Merge变更操作。</p>
</blockquote>
<p><img src="/images/2529502-20211208163538663-634533368.jpg" alt="InnoDB缓存区结构"></p>
<p>在什么场景下会触发ChangeBuffer的Merge操作?</p>
<blockquote>
<p>访问变更操作对应的数据页。</p>
<p>InnoDB后台定期Merge。</p>
<p>数据库BufferPool空间不足。</p>
<p>数据库正常关闭时。</p>
<p>RedoLog写满时。</p>
</blockquote>
<p>为什么ChangeBuffer只缓存非唯一索引数据?</p>
<blockquote>
<p>由于唯一索引需要进行唯一性校验，所以对唯一索引进行更新时必须将对应的数据页加载到缓存中进行校验，从而导致ChangeBuffer失效。</p>
</blockquote>
<p>ChangeBuffer适用场景:</p>
<blockquote>
<p>数据库大部分索引是非唯一索引。</p>
<p>业务是写多读少，或者不是写后立刻读取。</p>
</blockquote>
<p>普通索引还是唯一索引?</p>
<blockquote>
<p>从索引修改角度来看：</p>
<ul>
<li>由于非唯一索引无法使用ChangeBuffer，对索引的修改会引起大量的磁盘IO，影响数据库性能。</li>
</ul>
<p>如果不是业务中要求数据库对某个字段做唯一性检查，最好使用普通索引而不是唯一索引。</p>
</blockquote>
<p><strong>SQL查询</strong></p>
<blockquote>
<p>一条查询语句的执行过程一般是经过连接器、分析器、优化器、执行器等阶段后，最后到达存储引擎。</p>
</blockquote>
<img src="/images/image-20231021221338694.png" alt="image-20231021221338694" style="zoom:40%;" />

<p><strong>SQL更新</strong></p>
<img src="/images/image-20231021221734927.png" alt="image-20231021221734927" style="zoom:50%;" />

<h1 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h1><p><img src="/images/640-8242523.png" alt="图片"></p>
<p><strong>三个线程：</strong></p>
<blockquote>
<p><strong>binlog dump线程：</strong> </p>
<ul>
<li>主库中有数据更新时，将更新的事件类型写入到主库的binlog文件中，并创建log dump线程通知slave有数据更新。</li>
<li>将此时的binlog名称和当前更新的位置同时传给slave的I&#x2F;O线程。</li>
</ul>
<p><strong>I&#x2F;O线程：</strong> </p>
<ul>
<li>该线程会连接到master，向log dump线程请求一份指定binlog文件位置的副本，并将请求回来的binlog存到本地的relay log中。</li>
</ul>
<p><strong>SQL线程：</strong> </p>
<ul>
<li>该线程检测到relay log有更新后，会读取并在本地做redo操作，将发生在主库的事件在本地重新执行一遍，来保证主从数据同步。</li>
</ul>
</blockquote>
<p><strong>基本过程</strong></p>
<blockquote>
<p>主库写入数据并且生成binlog文件。</p>
<p>从库服务器上的IO线程连接Master服务器，请求从执行binlog日志文件中的指定位置开始读取binlog至从库。</p>
<p>主库接收到从库的IO线程请求后，会根据Slave的请求信息分批读取binlog文件然后返回给从库的IO线程。</p>
<p>Slave服务器的IO线程获取到Master服务器上IO线程发送的日志内容、日志文件及位置点后，会将binlog日志内容依次写到Slave端自身的Relay Log（即中继日志）。</p>
<p>从库服务器的SQL线程会实时监测到本地Relay Log中新增了日志内容，然后把RelayLog中的日志翻译成SQL并且按照顺序执行SQL来更新从库的数据。</p>
</blockquote>
<p><strong>主从延时原因</strong></p>
<blockquote>
<p>主从延迟主要是出现在 relay log 回放 这一步。</p>
<p>当主库的 TPS 并发较高，产生的 DDL 数量超过从库一个 SQL 线程所能承受的范围，那么延时就产生了。</p>
<p>还有就是可能与从库的大型 query 语句产生了锁等待。</p>
</blockquote>
<p><strong>主从延时解决方案</strong></p>
<blockquote>
<p>缩短主从同步时间：</p>
<ul>
<li>提升从库机器配置，可以和主库一样，甚至更好。</li>
<li>避免大事务。</li>
<li>搞多个从库，即一主多从，分担从库查询压力。</li>
<li>优化网络宽带。</li>
<li>选择高版本 MySQL，支持主库 binlog 多线程复制。</li>
</ul>
<p>从业务场景考虑：</p>
<ul>
<li>使用缓存：<ul>
<li>在同步写数据库的同时，也把数据写到缓存，查询数据时，会先查询缓存。</li>
<li>这种情况会带来 MySQL 和 Redis 数据一致性问题。</li>
</ul>
</li>
<li>查询主库：<ul>
<li>直接查询主库，这种情况会给主库太大压力，核心场景可以使用，比如订单支付。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h1><p><strong>查询：</strong></p>
<blockquote>
<p><code>owner_id</code>字段里面存的值是用逗号隔开的多个人的数据，想随便拿一个数据。</p>
</blockquote>
<pre><code class="sql">select * from appinfo where concat (&#39;,&#39;,owner_id,&#39;,&#39;) regexp &#39;,123123,&#39;
</code></pre>
<blockquote>
<p>分组：</p>
</blockquote>
<pre><code class="sql">select userBulkId, count(*) from topic_lesson_user_bulk_member group by userBulkId;
</code></pre>
<blockquote>
<p>根据时间戳查询：</p>
</blockquote>
<pre><code class="sql">select count(distinct userId) from access_rule where unix_timestamp(dbctime) &lt; 1673031600 and unix_timestamp(dbctime) &gt; 1673020800;
</code></pre>
<p><strong>新增：</strong></p>
<blockquote>
<p><code>t_feed_user_black_list</code>表中的user_id值批量存入<code>t_recommend_black</code>表中。</p>
</blockquote>
<pre><code class="sql">insert into t_recommend_black(user_id) select user_id from t_feed_user_black_liston duplicate key update user_id =values(user_id);
</code></pre>
<blockquote>
<p><code>t_exposure</code>表中的<code>exposure_id，edition</code>值批量存入<code>t_exposure_edition</code>表中。</p>
</blockquote>
<pre><code class="sql">insert into t_exposure_edition(exposure_id, edition) select exposure_id,&#39;full&#39; from t_exposure;
</code></pre>
<p><strong>修改</strong></p>
<pre><code class="sql">update live_video set transJobId = 1307569, jobStatus = 1 where id = 1;
</code></pre>
<p><strong>添加索引</strong></p>
<pre><code class="sql">alter table qw_user_record add index idx_qwUserId(qwUserId);
</code></pre>
<p><strong>删除字段</strong></p>
<pre><code class="sql">ALTER TABLE qw_activity DROP status;
</code></pre>
<p><strong>添加字段</strong></p>
<pre><code class="sql">ALTER TABLE qw_activity ADD status TINYINT(1) DEFAULT 0 COMMENT &#39;活动状态:1(未开始),2(进行中),3(已结束)&#39;;
</code></pre>
<p><strong>修改字段</strong></p>
<pre><code class="sql">ALTER TABLE operate_log MODIFY content JSON COMMENT &#39;历史版本配置以及内容&#39;;
</code></pre>
<blockquote>
<p>修改字段名:</p>
</blockquote>
<pre><code class="sql">alter table anniversary_activity_user change user_id userId;
</code></pre>

	</div>
</div>


    <div class="post-guide">
        <div class="item left">
            
              <a href="/2022/12/10/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  并发编程
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/2022/11/27/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/JVM/">
                JVM
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>




<script>

    //document.oncontextmenu=new Function("event.returnValue=false");
	//document.onselectstart=new Function("event.returnValue=false");

	

	$(function () {
		const btw = new BTWPlugin();
	    btw.init({
	        id: 'container',
	        blogId: '22377-1701134716680-506',
	        name: '月伴飞鱼',
	        qrcode: '/小程序码.jpg',
	        keyword: '验证码',
	    });

	    var contents = document.getElementsByClassName("content999");
	    //监听文章内容的copy事件
	    contents[0].addEventListener('copy',function(e){
	        setClipboardText(e);
	    });

	    function setClipboardText(event){
	        // clipboardData 对象是为通过编辑菜单、快捷菜单和快捷键执行的编辑操作所保留的，也就是你复制或者剪切内容
	        let clipboardData = event.clipboardData || window.clipboardData;

	        // 如果未复制或者未剪切，则return出去
	        if (!clipboardData) { return; }

	        event.preventDefault();

	        // Selection 对象，表示用户选择的文本范围或光标的当前位置。
	        // 声明一个变量接收 -- 用户输入的剪切或者复制的文本转化为字符串
	        let text = window.getSelection().toString();
	    
	        if (text) {
	            // 如果文本存在则先取消文本默认事件
	            event.preventDefault();
	            // 通过调用常clipboardData对象的 setData(format, data) 方法；来设置相关文本
	            // format: 一个DOMString 表示要添加到 drag object的拖动数据的类型。
	            // data: 一个 DOMString表示要添加到 drag object的数据。
	            var copyright = '\n\n'
	            + '\n著作权归作者所有。'
	            + '\n商业转载请联系作者获得授权，非商业转载请注明出处。'
	            + '\n作者: 月伴飞鱼'
	            + '\n原文地址: https://hardyfish.top/2022/12/02/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/'
	    
	            clipboardData.setData('text/plain', text + copyright);
	    
	        }
	    };
	});

	
</script>

<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '22377-1701134716680-506',
        name: '月伴飞鱼',
        qrcode: '/小程序码.jpg',
        keyword: '验证码',
    });
</script>
	</div>
	<div id="footer">
	<p>
	©2019-<span id="footerYear"></span> 
	<a href="/">月伴飞鱼</a> 
	
	
		|
		<span id="busuanzi_container_site_pv">
			PV 180986
		</span>
		|
		<span id="busuanzi_container_site_uv"> 
			UV 10079
		</span>
	
	<br>
	微信搜索 <a href="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/个人公众号.jpg" target="_blank">月伴飞鱼</a> 关注我
	</p>
</div>
<script type="text/javascript"> 
	document.getElementById('footerYear').innerHTML = new Date().getFullYear() + '';
</script>
	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>